name: frontend-ci

on:
  deployment_status:

jobs:
  notify:
    runs-on: ubuntu-latest
    steps:
      - name: Extract deployment info
        id: info
        run: |
          echo "STATE=${{ github.event.deployment_status.state }}" >> $GITHUB_ENV
          echo "URL=${{ github.event.deployment_status.target_url }}" >> $GITHUB_ENV
          echo "DESC=${{ github.event.deployment_status.description }}" >> $GITHUB_ENV

      - name: Get Commit Messages
        id: get_commits
        run: |
          if [ "${{ github.event_name }}" == "push" ]; then
            COMMITS=$(echo '${{ toJSON(github.event.commits) }}' | jq -r '.[] | "- [" + (.message | split("\n")[0]) + "](" + .url + ")"')
          else
            COMMITS="Manual Trigger / Not a push event"
          fi
          echo "COMMITS<<EOF" >> $GITHUB_ENV
          echo "$COMMITS" >> $GITHUB_ENV
          echo "EOF" >> $GITHUB_ENV
      - name: Notify Telegram (Success)
        if: success()
        run: |
          TEXT=$(cat <<'EOF'
          âœ… *Frontend Deploy Success!*
          
          Repository: [${{ github.repository }}](${{ github.server_url }}/${{ github.repository }})
          Branch: [${{ github.ref_name }}](${{ github.server_url }}/${{ github.repository }}/tree/${{ github.ref_name }})
          By: [${{ github.actor }}](${{ github.server_url }}/${{ github.actor }})
                    
          *Commits:*
          ${{ env.COMMITS }}

          ðŸŒ *URL:* ${{ env.URL }}
          ðŸ“ *Description:* ${{ env.DESC }}
          
          ðŸ§© [View Workflow Logs](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})
          EOF
          )
          TEXT_URLENCODED=$(echo "$TEXT" | jq -s -R -r @uri)
          curl -s -X POST "https://api.telegram.org/bot${{ secrets.TELEGRAM_BOT_TOKEN }}/sendMessage" \
            -d chat_id="${{ secrets.TELEGRAM_CHAT_ID }}" \
            -d message_thread_id="${{ secrets.TELEGRAM_TOPIC_ID }}" \
            -d text="$TEXT_URLENCODED" \
            -d parse_mode="Markdown" \
            -d disable_web_page_preview="true"

      - name: Notify Telegram (Failed)
        if: failure()
        run: |
          TEXT=$(cat <<'EOF'
          âŒ *Frontend Deploy Failed*
          
          Repository: [${{ github.repository }}](${{ github.server_url }}/${{ github.repository }})
          Branch: [${{ github.ref_name }}](${{ github.server_url }}/${{ github.repository }}/tree/${{ github.ref_name }})
          By: [${{ github.actor }}](${{ github.server_url }}/${{ github.actor }})

          *Commits:*
          ${{ env.COMMITS }}

          ðŸ“ *Description:* ${{ env.DESC }}
          
          ðŸ§© [View Workflow Logs](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})
          EOF
          )
          TEXT_URLENCODED=$(echo "$TEXT" | jq -s -R -r @uri)
          curl -s -X POST "https://api.telegram.org/bot${{ secrets.TELEGRAM_BOT_TOKEN }}/sendMessage" \
            -d chat_id="${{ secrets.TELEGRAM_CHAT_ID }}" \
            -d message_thread_id="${{ secrets.TELEGRAM_TOPIC_ID }}" \
            -d text="$TEXT_URLENCODED" \
            -d parse_mode="Markdown" \
            -d disable_web_page_preview="true"